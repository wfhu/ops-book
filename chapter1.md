# 运维能力第一阶段--满足业务需求

---

## 一：满足业务对资源需求的能力

业务对资源的合理需求必须得到满足，保证质量和效率的同时需要控制好成本。

主要从以下三个方面考虑：

* 效率：同样的资源需求，多久能得到满足，一个月、一个星期、一天或者2小时，对业务部门来说是有质的区别的。

* 质量：给出来的资源质量如何？是否符合预期？前后一致性是否有保障？

* 成本：成本可以增长，但必须是可控的。

#### 1.1、使用物理IDC机房，租赁机柜和带宽，自己购买服务器

**优势**

* 机器配置和网络架构更加自主可控
* 物理隔离更安全
* 可选择部署地域更广
* 性能可预期
* 上规模时成本有优势

**劣势**

* 交付周期长
* 防攻击抵御能力差
* 可伸缩性比较差

**选择物理机房的技术准备**

* 远程管理卡和远程管理网络

* 系统安装服务，如FAI、PXE、Cobbler等

* 网络上联出口高可用

* 服务器网卡设置bonding

* 公网互联互通，考虑出口线路

#### 1.2、直接租赁专用物理服务器

**优势**

* 交付周期相对较短，一般在几小时或者几日内能交付
* 具备一定程度的可伸缩性，一般按月租赁，退租方便

**劣势**

* 成本偏高
* 知名的厂商有：Softlayer、RackSpace、NTT等

#### 1.3、选择传统物理IDC机房方法

**看机房建设标准**

比如国内机房有所谓三星、四星、五星机房，国外有Tier-2，Tier-3，Tier-4等，理论上级别越高机房越可靠。

**看机房地理位置和建筑外形**

优先选择地理位置在郊区、独栋的专业IDC机房，这些一般比处在市中心、高楼大厦中划分某几层用来做IDC的要好。

**选择知名的IDC机房供应商**

比如选择Equinix、Digital Realty、NTT等提供的机房，一般机房本身的品质有保障。

这里可以重点关注一下Equinix机房，他主推的IBX服务，机房质量和网络的互联互通都比较好。

更多关于IDC选择的标准，可以参考[UptimeInstitute](https://uptimeinstitute.com/)。

#### 1.4、选择云服务厂商

云服务厂商用得越来越多，我们也可以充分利用其优势和特点，帮助我们支持好业务的运行。

**优势**

* 资源和服务获取速度快
* 可伸缩性强
* 降低服务使用的技术门槛

**劣势**

* 安全不可控
* 性能不可控
* 排查问题存在黑盒

**AWS**

云服务领域的绝对老大

使用过的特色服务：

Lambda：无服务器运行环境

Athena： Hive as a Service

S3：近乎无限可扩展的对象存储服务

需要注意的地方：

AccessKey的安全性要注意，不建议使用，一旦泄露影响非常大；建议使用IAM和MFA管理用户权限

EC2存储区分持久存储和临时存储，临时存储在关机-再开机后数据全部丢失

EC2实例默认不能转发数据包，需要后台设置运行转发

注意各种资源的购买限制，如果没规划好，突发需求可能不能马上得到满足

**阿里云**

国内云服务的领导者

使用过的特色服务：

高速通道

需要注意的地方：

管理后台用户体验极差，一般建议自己通过API自定义UI，但是API很不健全

ECS实例里面有运维阿里云的多个agent，安全性和可靠性有待考量

#### 1.5、CDN服务

一般来讲，现在的企业都不会自己建设CDN，一般选择外包给专业的CDN服务商。

**Akamai**

老牌CDN服务商，全球CDN及相关服务的老大，绝对的技术领头羊和市场领导者

优点

网络覆盖好，接入ISP达到1700+，用户体验好，防攻击能力强，可配置性极强

缺点

服务较差，费用比较贵，后台配置麻烦，刷新缓存\(Purge\)比较慢

**AWS CloudFront**

亚马逊云服务的一个产品，近年来表现不错，持续扩张中

优点

后台配置简单，即开即用，和AWS其他服务结合紧密

缺点

并非专业的CDN厂商，节点覆盖不多，全球节点不到100个，可配置性较差

**CloudFlare**

这些年新出的一个CDN厂商，大量使用anycast技术，主打高性能、低价和防攻击，占领了大量中小企业市场

优点

费用较低，企业级套餐可能只有Akamai的三分之一价格；配置比较简单方便；刷新缓存\(Purge\)极快

缺点

回源模式单一，不支持源站+子目录形式回源；

#### 1.6、DNS域名解析服务

DNS服务往往容易被人忽略，但是其实DNS服务是非常核心的服务，也是比较脆弱的服务，容易成为攻击的目标

**自建DNS服务**

安全性方面需要考虑一下问题：DDOS，DNS放大攻击，zone transfer访问控制，高可用

功能方面：智能DNS功能，分布式访问性能

**DNSPOD**

国内知名的DNS域名解析服务提供商，有免费版但不保证可用性，经常用来当小白鼠测试新功能；企业版比较不错，各种运营商线路以及国内外区分，基本满足国内业务的需求。

提供HTTP DNS服务，可有效避免DNS拦截。

**AWS Route53**

支持智能DNS，对海外国家/地区区分较好；有CNAME flatting等功能。

**Akamai FastDNS**

功能比较单一，没有智能DNS功能。

> 有一个问题：不支持同一个域名修改record类型，只能删除再添加，会导致服务短暂中断。如：www.mysite.com CNAME 到 mycdn.akam.net，需要修改成 A 记录并指向 IP 1.2.3.4，只能删除原有CNAMEA记录记录再重新添加，不能直接修改记录类型。

#### 1.7、容量（能力）管理

从ITIL中的Capacity managememt而来，是资源规划的是否有效的方法。

容量管理主要需要考虑一下几个方面：

**业务预算搜集**

* 业务资源趋势判断
* 新增业务资源搜集

**资源池管理**

* 业务日常资源
* 业务突发资源
* 特殊故障资源

-工作案例：

1. 操作系统安装和配置标准化/自动化（kickstart/PXE），云主机模板
2. 开发服务器/CDN常见操作自助功能
3. 物理机房网络和机架调整和优化
4. 物理机房资源池建设和业务预算
5. 迁移业务至云服务商
6. HP/DELL/华为设备采购签订年度框架协议
7. CDN引入Cloudflare
8. 日志分析直接上无服务的架构

## 二：满足业务发布/变更的能力

运维不能成为阻挡业务发布和变更的障碍

1. 效率: 自助操作
2. 质量: 流程化/规范化

### 发布系统

### 持续集成和持续交付

### 作业系统

-工作案例：

1. 开发发布系统，业务自助发布
2. 引入RUNDECK作业系统，固化常用操作，授权业务自己操作
3. 基于k8s/Docker/SVN/Jenkins的测试环境自动持续集成

## 三：快速获取业务相关信息的能力

有异常能发现，平时不出故障，出故障有预案，能快速定位解决

1. 效率: 自助化/可视化/用户体验 基础设施既代码 配置管理 文档

2. 质量: 多维度监控覆盖

3. 屏蔽复杂度，给需要数据的部门/业务，提供统一的获取数据的接口

## 监控和报警系统

### 基础监控

### 系统监控

### 网络监控

### 应用监控

### Statsd

### 业务监控

### 第三方监控

## 日志分析

### ELK系统

## 调用追踪系统

OpenTrace

OpenZipkin

-工作案例：

1. 引入WIKI工具，规范工作文档
2. 引入puppet/saltstack工具维护线上环境配置，环境可重现
3. zabbix/smokeping/prometheus/graphite/grafana多维度监控和可视化
4. 集群基础设施引入CloudFormation/Terraform等工具管理

## 四：满足业务对可用性和稳定性要求的能力

默认一切都是不可靠的，都是会出故障的

（跑的好不好，现在、未来、持久地跑好）

1. 质量: 去单点 故障自愈能力 安全规范和扫描
2. 效率: 预案和演练

架构高可用（去单点）

服务自动恢复

横向可扩展性

安全、可控、可预期

-核心能力/概念

：知识/故障管理，可扩展性，可靠性和运行效率

-工作案例：

1. WEB层全面去单点
2. 引入Docker集群，自动故障漂移/恢复
3. 例行强制重启任意一台业务机，确保高可用能力
4. 引入Nessus/OpenVAS例行扫描，发现对外开放的免密的redis/memcache等

## 五、快速部署和故障恢复的能力

故障演练和预案

基础设施即代码（Infrastructure as Code）

CloudFormation

TerraForm

配置管理工具

系统镜像和模板

备份与恢复

不可变基础设施

